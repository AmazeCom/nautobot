{% extends 'base.html' %}
{% load buttons %}
{% load helpers %}
{% load static %}
{% load django_tables2 %}

{% block extra_styles %}
    {{ block.super }}
{% endblock %}
{% block content %}
<form action="" method="post" enctype="multipart/form-data" class="form form-horizontal">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="panel panel-danger">
                <div class="panel-heading"><strong>Confirm Merging These Duplicate IP Addresses</strong></div>
                <div class="panel-body">
                    <p><strong>Warning:</strong> The following operation will merge these {{ queryset.count }} IP Addresses. Please select the attributes you want to keep in the merged IP Address.</p>
                    {% block message_extra %}{% endblock %}
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="panel panel-default">
                <table class="table table-hover table-headings">
                <thead>
                    <th>
                        Merging IP Addresses
                    </th>
                    <th>
                        Host
                    </th>
                    <th>
                        Mask Length
                    </th>
                    <th>
                        Namespace
                    </th>
                    <th>
                        Type
                    </th>
                    <th>
                        Status
                    </th>
                    <th>
                        Role
                    </th>
                    <th>
                        DNS Name
                    </th>
                    <th>
                        Description
                    </th>
                    <th>
                        Tenant
                    </th>
                    <th>
                        NAT IP (Inside)
                    </th>
                    <th>
                        Tags
                    </th>
                    {% for label in custom_field_labels %}
                    <th>
                        {{ label }}
                    </th>
                    {% endfor %}
                    {% with relationships=queryset.first.get_relationships_data %}
                            {% if relationships.source or relationships.destination or relationships.peer %}
                                {% for side, relationships in relationships.items %}
                                    {% for relationship, value in relationships.items %}
                                    <th>
                                        {{ value.label }}
                                    </th>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                    {% endwith %}
                </thead>
                <tbody>
                {% for ip in queryset %}
                        <tr>
                            <td>
                                <input type="checkbox" id="pk" name="pk" value="{{ip.pk}}" checked>
                                <label for="pk"><a href="{% url 'ipam:ipaddress' ip.pk %}">{{ ip }}</a></label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="hidden" id="host" name="host" value="{{ip.host}}" checked>
                                {% endif %}
                                <label for="host">{{ip.host}}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="mask_length" name="mask_length" value="{{ip.mask_length}}" required checked>
                                {% else %}
                                    <input type="radio" id="mask_length" name="mask_length" value="{{ip.mask_length}}" required>
                                {% endif %}
                                <label for="mask_length">{{ip.mask_length | placeholder }}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="namespace" name="namespace" value="{{ip.parent.namespace.pk}}" required checked>
                                {% else %}
                                    <input type="radio" id="namespace" name="namespace" value="{{ip.parent.namespace.pk}}" required>
                                {% endif %}
                                <label for="namespace">{{ip.parent.namespace | hyperlinked_object }}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="type" name="type" value="{{ip.type}}" required checked>
                                {% else %}
                                    <input type="radio" id="type" name="type" value="{{ip.type}}" required>
                                {% endif %}
                                <label for="type">{{ip.type}}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="status" name="status" value="{{ip.status.pk}}" required checked>
                                {% else %}
                                    <input type="radio" id="status" name="status" value="{{ip.status.pk}}" required>
                                {% endif %}
                                <label for="status">{{ip.status | hyperlinked_object}}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="role" name="role" value="{{ip.role.pk}}" required checked>
                                {% else %}
                                    <input type="radio" id="role" name="role" value="{{ip.role.pk}}" required>
                                {% endif %}
                                <label for="role">{{ip.role | hyperlinked_object}}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="dns_name" name="dns_name" value="{{ip.dns_name}}" required checked>
                                {% else %}
                                    <input type="radio" id="dns_name" name="dns_name" value="{{ip.dns_name}}" required>
                                {% endif %}
                                <label for="dns_name">{{ip.dns_name | placeholder}}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="description" name="description" value="{{ip.description}}" required checked>
                                {% else %}
                                    <input type="radio" id="description" name="description" value="{{ip.description}}" required>
                                {% endif %}
                                <label for="description">{{ip.description | placeholder }}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="tenant" name="tenant" value="{{ip.tenant.pk}}" required checked>
                                {% else %}
                                    <input type="radio" id="tenant" name="tenant" value="{{ip.tenant.pk}}" required>
                                {% endif %}
                                <label for="tenant">{{ip.tenant | hyperlinked_object}}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="nat_inside" name="nat_inside" value="{{ip.nat_inside.pk}}" required checked>
                                {% else %}
                                    <input type="radio" id="nat_inside" name="nat_inside" value="{{ip.nat_inside.pk}}" required>
                                {% endif %}
                                <label for="nat_inside">{{ip.nat_inside | hyperlinked_object}}</label>
                            </td>
                            <td>
                                {% if forloop.first %}
                                    <input type="radio" id="tags" name="tags" value="{{ip.tags.all | queryset_to_pks}}" required checked>
                                {% else %}
                                <input type="radio" id="tags" name="tags" value="{{ip.tags.all | queryset_to_pks}}" required>
                                {% endif %}
                                <label for="tags">
                                    {% for tag in ip.tags.all %}
                                        {% tag tag url %}
                                    {% empty %}
                                        {{ ip.tags.all | placeholder }}
                                    {% endfor %}
                                </label>
                            </td>
                            {% for key in custom_field_keys %}
                                <td>
                                    <input type="radio" id="cf_{{key}}" name="cf_{{key}}" value="{{ip.cf | get_item:key }}" required {% if forloop.parentloop.first %} checked {% endif %}>
                                    <label for="cf_{{key}}">{{ip.cf | get_item:key | placeholder}}</label>
                                </td>
                            {% endfor %}
                            {% with relationships=ip.get_relationships_data %}
                            {% if relationships.source or relationships.destination or relationships.peer %}
                                {% for side, relationships in relationships.items %}
                                    {% for relationship, value in relationships.items %}
                                        {% if not value.has_many and value.value %}
                                            <td>
                                                <input type="radio" id="cr_{{relationship.key}}" name="cr_{{relationship.key}}" value="{{ value.value.pk }}" required {% if forloop.parentloop.parentloop.first %} checked {% endif %}>
                                                <label for="cr_{{relationship.key}}"><a href="{{ value.url }}">{{ value.value }}</a></label>
                                            </td>
                                        {% elif value.has_many and value.queryset.count %}
                                            <td>
                                                <input type="radio" id="cr_{{relationship.key}}" name="cr_{{relationship.key}}" value="{{ value.queryset | queryset_to_pks }}" required {% if forloop.parentloop.parentloop.first %} checked {% endif %}>
                                                <label for="cr_{{relationship.key}}"> 
                                                    <a href="{% url 'extras:relationshipassociation_list' %}?relationship={{relationship.key}}&{{side}}_id={{object.id}}">
                                                        {{ value.queryset.count }}
                                                        {% if value.peer_type.model_class is not None %}
                                                            {% if value.queryset.count > 1 %}
                                                                {{ value.peer_type.model_class|meta:"verbose_name_plural" }}
                                                            {% else %}
                                                                {{ value.peer_type.model_class|meta:"verbose_name" }}
                                                            {% endif %}
                                                        {% else %}
                                                            {{ value.peer_type }}(s)
                                                        {% endif %}
                                                    </a>
                                            </label>
                                            </td>
                                        {% else %}
                                            <td>
                                                <input type="radio" id="cr_{{relationship.key}}" name="cr_{{relationship.key}}" value="" required {% if forloop.parentloop.parentloop.first %} checked {% endif %}>
                                                <label for="cr_{{relationship.key}}"><span class="text-muted">&mdash;</span></label>
                                            </td>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        </tr>
                {% endfor %}
                </tbody>    
            </table>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-10 col-md-offset-7">
        {% block buttons %}
            <button type="submit" name="_merge" class="btn btn-primary"><i class="mdi mdi-arrow-down-bold"></i> Merge and Go to the Next Duplicates</button>
            <button type="submit" name="_skip" class="btn btn-warning"><i class="mdi mdi-arrow-right-bold"></i> Skip and Go to the Next Duplicates</button>
            <a href="{{ return_url }}" class="btn btn-default">Cancel</a>
        {% endblock %}
    </div>
</div>
</form>
{% endblock %}